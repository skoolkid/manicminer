<!DOCTYPE html>
<html>
<head>
<title>Manic Miner: Routine at 8EF1</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Manic Miner" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8E75.html">8E75</a>
</td>
<td class="up">Up: <a href="../maps/all.html#8ef1">Map</a></td>
<td class="next">
Next: <a href="8F63.html">8F63</a>
</td>
</tr>
</table>
<div class="description">8EF1: Move and draw the vertical guardians in the current cavern</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="870E.html">870E</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8ef1"></span>8EF1</td>
<td class="instruction">LD IY,$80DD</td>
<td class="comment-1" rowspan="1">Point <span class="register">IY</span> at the first byte of the first vertical guardian definition at <a href="80DD.html">80DD</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8ef5"></span>
<div class="comments">
<div class="paragraph">
The guardian-moving loop begins here.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8ef5"></span>8EF5</td>
<td class="instruction">LD A,(IY+$00)</td>
<td class="comment-1" rowspan="1">Pick up the first byte of the guardian definition</td>
</tr>
<tr>
<td class="address-1"><span id="8ef8"></span>8EF8</td>
<td class="instruction">CP $FF</td>
<td class="comment-1" rowspan="1">Have we dealt with all the guardians yet?</td>
</tr>
<tr>
<td class="address-1"><span id="8efa"></span>8EFA</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="8efb"></span>8EFB</td>
<td class="instruction">INC (IY+$01)</td>
<td class="comment-1" rowspan="1">Increment the guardian's animation frame</td>
</tr>
<tr>
<td class="address-1"><span id="8efe"></span>8EFE</td>
<td class="instruction">RES 2,(IY+$01)</td>
<td class="comment-1" rowspan="1">Reset the animation frame to 0 if it overflowed to 4</td>
</tr>
<tr>
<td class="address-1"><span id="8f02"></span>8F02</td>
<td class="instruction">LD A,(IY+$02)</td>
<td class="comment-1" rowspan="1">Pick up the guardian's pixel y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="8f05"></span>8F05</td>
<td class="instruction">ADD A,(IY+$04)</td>
<td class="comment-1" rowspan="1">Add the current y-coordinate increment</td>
</tr>
<tr>
<td class="address-1"><span id="8f08"></span>8F08</td>
<td class="instruction">CP (IY+$05)</td>
<td class="comment-1" rowspan="1">Has the guardian reached the highest point of its path (minimum y-coordinate)?</td>
</tr>
<tr>
<td class="address-1"><span id="8f0b"></span>8F0B</td>
<td class="instruction">JR C,<a href="8EF1.html#8f17">$8F17</a></td>
<td class="comment-1" rowspan="1">If so, jump to change its direction of movement</td>
</tr>
<tr>
<td class="address-1"><span id="8f0d"></span>8F0D</td>
<td class="instruction">CP (IY+$06)</td>
<td class="comment-1" rowspan="1">Has the guardian reached the lowest point of its path (maximum y-coordinate)?</td>
</tr>
<tr>
<td class="address-1"><span id="8f10"></span>8F10</td>
<td class="instruction">JR NC,<a href="8EF1.html#8f17">$8F17</a></td>
<td class="comment-1" rowspan="1">If so, jump to change its direction of movement</td>
</tr>
<tr>
<td class="address-1"><span id="8f12"></span>8F12</td>
<td class="instruction">LD (IY+$02),A</td>
<td class="comment-1" rowspan="1">Update the guardian's pixel y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="8f15"></span>8F15</td>
<td class="instruction">JR <a href="8EF1.html#8f1f">$8F1F</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="8f17"></span>8F17</td>
<td class="instruction">LD A,(IY+$04)</td>
<td class="comment-1" rowspan="3">Negate the y-coordinate increment; this changes the guardian's direction of movement</td>
</tr>
<tr>
<td class="address-1"><span id="8f1a"></span>8F1A</td>
<td class="instruction">NEG</td>
</tr>
<tr>
<td class="address-1"><span id="8f1c"></span>8F1C</td>
<td class="instruction">LD (IY+$04),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8f1f"></span>
<div class="comments">
<div class="paragraph">
Now that the guardian's movement has been dealt with, time to draw it.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="8f1f"></span>8F1F</td>
<td class="instruction">LD A,(IY+$02)</td>
<td class="comment-1" rowspan="1">Pick up the guardian's pixel y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="8f22"></span>8F22</td>
<td class="instruction">AND $7F</td>
<td class="comment-1" rowspan="4">Point <span class="register">DE</span> at the entry in the screen buffer address lookup table at <a href="8300.html">8300</a> that corresponds to the guardian's pixel y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="8f24"></span>8F24</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f25"></span>8F25</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="8f26"></span>8F26</td>
<td class="instruction">LD D,$83</td>
</tr>
<tr>
<td class="address-1"><span id="8f28"></span>8F28</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="6">Point <span class="register">HL</span> at the address of the guardian's location in the screen buffer at <a href="6000.html">6000</a></td>
</tr>
<tr>
<td class="address-1"><span id="8f29"></span>8F29</td>
<td class="instruction">OR (IY+$03)</td>
</tr>
<tr>
<td class="address-1"><span id="8f2c"></span>8F2C</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="8f2d"></span>8F2D</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="address-1"><span id="8f2e"></span>8F2E</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="8f2f"></span>8F2F</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="8f30"></span>8F30</td>
<td class="instruction">LD A,(IY+$01)</td>
<td class="comment-1" rowspan="1">Pick up the guardian's animation frame (0-3)</td>
</tr>
<tr>
<td class="address-1"><span id="8f33"></span>8F33</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="3">Multiply it by 32</td>
</tr>
<tr>
<td class="address-1"><span id="8f34"></span>8F34</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f35"></span>8F35</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f36"></span>8F36</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">DE</span> at the graphic data for the appropriate guardian sprite (at <a href="8100.html">8100</a>+<span class="register">A</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="8f37"></span>8F37</td>
<td class="instruction">LD D,$81</td>
</tr>
<tr>
<td class="address-1"><span id="8f39"></span>8F39</td>
<td class="instruction">LD C,$01</td>
<td class="comment-1" rowspan="2">Draw the guardian to the screen buffer at <a href="6000.html">6000</a></td>
</tr>
<tr>
<td class="address-1"><span id="8f3b"></span>8F3B</td>
<td class="instruction">CALL <a href="8FF4.html">$8FF4</a></td>
</tr>
<tr>
<td class="address-1"><span id="8f3e"></span>8F3E</td>
<td class="instruction">JP NZ,<a href="8D05.html#8d06">$8D06</a></td>
<td class="comment-1" rowspan="1">Kill Willy if the guardian collided with him</td>
</tr>
<tr>
<td class="address-1"><span id="8f41"></span>8F41</td>
<td class="instruction">LD A,(IY+$02)</td>
<td class="comment-1" rowspan="1">Pick up the guardian's pixel y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="8f44"></span>8F44</td>
<td class="instruction">AND $40</td>
<td class="comment-1" rowspan="11">Point <span class="register">HL</span> at the address of the guardian's location in the attribute buffer at <a href="5C00.html">5C00</a></td>
</tr>
<tr>
<td class="address-1"><span id="8f46"></span>8F46</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f47"></span>8F47</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f48"></span>8F48</td>
<td class="instruction">ADD A,$5C</td>
</tr>
<tr>
<td class="address-1"><span id="8f4a"></span>8F4A</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="8f4b"></span>8F4B</td>
<td class="instruction">LD A,(IY+$02)</td>
</tr>
<tr>
<td class="address-1"><span id="8f4e"></span>8F4E</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f4f"></span>8F4F</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="8f50"></span>8F50</td>
<td class="instruction">AND $E0</td>
</tr>
<tr>
<td class="address-1"><span id="8f52"></span>8F52</td>
<td class="instruction">OR (IY+$03)</td>
</tr>
<tr>
<td class="address-1"><span id="8f55"></span>8F55</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="8f56"></span>8F56</td>
<td class="instruction">LD A,(IY+$00)</td>
<td class="comment-1" rowspan="1">Pick up the guardian's attribute byte</td>
</tr>
<tr>
<td class="address-1"><span id="8f59"></span>8F59</td>
<td class="instruction">CALL <a href="8DF8.html#8e5f">$8E5F</a></td>
<td class="comment-1" rowspan="1">Set the attribute bytes for the guardian</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="8f5c"></span>
<div class="comments">
<div class="paragraph">
The current guardian definition has been dealt with. Time for the next one.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="8f5c"></span>8F5C</td>
<td class="instruction">LD DE,$0007</td>
<td class="comment-1" rowspan="2">Point <span class="register">IY</span> at the first byte of the next vertical guardian definition</td>
</tr>
<tr>
<td class="address-1"><span id="8f5f"></span>8F5F</td>
<td class="instruction">ADD IY,DE</td>
</tr>
<tr>
<td class="address-1"><span id="8f61"></span>8F61</td>
<td class="instruction">JR <a href="8EF1.html#8ef5">$8EF5</a></td>
<td class="comment-1" rowspan="1">Jump back to deal with the next vertical guardian</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="8E75.html">8E75</a>
</td>
<td class="up">Up: <a href="../maps/all.html#8ef1">Map</a></td>
<td class="next">
Next: <a href="8F63.html">8F63</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Manic Miner RAM disassembly 20200731</div>
<div class="copyright">&#169; 1983 Bug-Byte Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/36593.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>