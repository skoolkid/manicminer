<!DOCTYPE html>
<html>
<head>
<title>Manic Miner: Routine at 34436</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Manic Miner" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="34252.html">34252</a>
</td>
<td class="up">Up: <a href="../maps/all.html#34436">Map</a></td>
<td class="next">
Next: <a href="34574.html">34574</a>
</td>
</tr>
</table>
<div class="description">34436: Start the game (or demo mode)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="34252.html">34252</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="34436"></span>34436</td>
<td class="instruction">LD HL,33829</td>
<td class="comment-1" rowspan="5">Initialise the score at <a href="33829.html">33829</a></td>
</tr>
<tr>
<td class="address-1"><span id="34439"></span>34439</td>
<td class="instruction">LD DE,33830</td>
</tr>
<tr>
<td class="address-1"><span id="34442"></span>34442</td>
<td class="instruction">LD BC,9</td>
</tr>
<tr>
<td class="address-1"><span id="34445"></span>34445</td>
<td class="instruction">LD (HL),48</td>
</tr>
<tr>
<td class="address-1"><span id="34447"></span>34447</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="34449"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="34574.html">34574</a> (when teleporting into a cavern or reinitialising the current cavern after Willy has lost a life) and <a href="36904.html">36904</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="34449"></span>34449</td>
<td class="instruction">LD A,(33799)</td>
<td class="comment-1" rowspan="1">Pick up the number of the current cavern from <a href="33799.html">33799</a></td>
</tr>
<tr>
<td class="address-1"><span id="34452"></span>34452</td>
<td class="instruction">SLA A</td>
<td class="comment-1" rowspan="5">Point <span class="register">HL</span> at the first byte of the cavern definition</td>
</tr>
<tr>
<td class="address-1"><span id="34454"></span>34454</td>
<td class="instruction">SLA A</td>
</tr>
<tr>
<td class="address-1"><span id="34456"></span>34456</td>
<td class="instruction">ADD A,176</td>
</tr>
<tr>
<td class="address-1"><span id="34458"></span>34458</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="34459"></span>34459</td>
<td class="instruction">LD L,0</td>
</tr>
<tr>
<td class="address-1"><span id="34461"></span>34461</td>
<td class="instruction">LD DE,24064</td>
<td class="comment-1" rowspan="3">Copy the cavern's attribute bytes into the buffer at <a href="24064.html">24064</a></td>
</tr>
<tr>
<td class="address-1"><span id="34464"></span>34464</td>
<td class="instruction">LD BC,512</td>
</tr>
<tr>
<td class="address-1"><span id="34467"></span>34467</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="34469"></span>34469</td>
<td class="instruction">LD DE,32768</td>
<td class="comment-1" rowspan="3">Copy the rest of the cavern definition into the game status buffer at <a href="../buffers/gbuffer.html#32768">32768</a></td>
</tr>
<tr>
<td class="address-1"><span id="34472"></span>34472</td>
<td class="instruction">LD BC,512</td>
</tr>
<tr>
<td class="address-1"><span id="34475"></span>34475</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="34477"></span>34477</td>
<td class="instruction">CALL <a href="35445.html">35445</a></td>
<td class="comment-1" rowspan="1">Draw the current cavern to the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-1"><span id="34480"></span>34480</td>
<td class="instruction">LD HL,20480</td>
<td class="comment-1" rowspan="5">Clear the bottom third of the display file</td>
</tr>
<tr>
<td class="address-1"><span id="34483"></span>34483</td>
<td class="instruction">LD DE,20481</td>
</tr>
<tr>
<td class="address-1"><span id="34486"></span>34486</td>
<td class="instruction">LD BC,2047</td>
</tr>
<tr>
<td class="address-1"><span id="34489"></span>34489</td>
<td class="instruction">LD (HL),0</td>
</tr>
<tr>
<td class="address-1"><span id="34491"></span>34491</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="34493"></span>34493</td>
<td class="instruction">LD IX,32768</td>
<td class="comment-1" rowspan="4">Print the cavern name (see <a href="32768.html">32768</a>) at (16,0)</td>
</tr>
<tr>
<td class="address-1"><span id="34497"></span>34497</td>
<td class="instruction">LD C,32</td>
</tr>
<tr>
<td class="address-1"><span id="34499"></span>34499</td>
<td class="instruction">LD DE,20480</td>
</tr>
<tr>
<td class="address-1"><span id="34502"></span>34502</td>
<td class="instruction">CALL <a href="37562.html">37562</a></td>
</tr>
<tr>
<td class="address-1"><span id="34505"></span>34505</td>
<td class="instruction">LD IX,33816</td>
<td class="comment-1" rowspan="4">Print 'AIR' (see <a href="33816.html">33816</a>) at (17,0)</td>
</tr>
<tr>
<td class="address-1"><span id="34509"></span>34509</td>
<td class="instruction">LD C,3</td>
</tr>
<tr>
<td class="address-1"><span id="34511"></span>34511</td>
<td class="instruction">LD DE,20512</td>
</tr>
<tr>
<td class="address-1"><span id="34514"></span>34514</td>
<td class="instruction">CALL <a href="37562.html">37562</a></td>
</tr>
<tr>
<td class="address-1"><span id="34517"></span>34517</td>
<td class="instruction">LD A,82</td>
<td class="comment-1" rowspan="1">Initialise <span class="register">A</span> to 82; this is the MSB of the display file address at which to start drawing the bar that represents the air supply</td>
</tr>
<tr>
<td class="address-2"><span id="34519"></span>34519</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="4">Prepare <span class="register">HL</span> and <span class="register">DE</span> for drawing a row of pixels in the air bar</td>
</tr>
<tr>
<td class="address-1"><span id="34520"></span>34520</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="34521"></span>34521</td>
<td class="instruction">LD L,36</td>
</tr>
<tr>
<td class="address-1"><span id="34523"></span>34523</td>
<td class="instruction">LD E,37</td>
</tr>
<tr>
<td class="address-1"><span id="34525"></span>34525</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Save the display file address MSB in <span class="register">B</span> briefly</td>
</tr>
<tr>
<td class="address-1"><span id="34526"></span>34526</td>
<td class="instruction">LD A,(32956)</td>
<td class="comment-1" rowspan="1">Pick up the value of the initial air supply from <a href="32956.html">32956</a></td>
</tr>
<tr>
<td class="address-1"><span id="34529"></span>34529</td>
<td class="instruction">SUB 36</td>
<td class="comment-1" rowspan="2">Now <span class="register">C</span> determines the length of the air bar (in cell widths)</td>
</tr>
<tr>
<td class="address-1"><span id="34531"></span>34531</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="34532"></span>34532</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Restore the display file address MSB to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="34533"></span>34533</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Now <span class="register">BC</span> determines the length of the air bar (in cell widths)</td>
</tr>
<tr>
<td class="address-1"><span id="34535"></span>34535</td>
<td class="instruction">LD (HL),255</td>
<td class="comment-1" rowspan="2">Draw a single row of pixels across <span class="register">C</span> cells</td>
</tr>
<tr>
<td class="address-1"><span id="34537"></span>34537</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="34539"></span>34539</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increment the display file address MSB in <span class="register">A</span> (moving down to the next row of pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="34540"></span>34540</td>
<td class="instruction">CP 86</td>
<td class="comment-1" rowspan="1">Have we drawn all four rows of pixels in the air bar yet?</td>
</tr>
<tr>
<td class="address-1"><span id="34542"></span>34542</td>
<td class="instruction">JR NZ,<a href="34436.html#34519">34519</a></td>
<td class="comment-1" rowspan="1">If not, jump back to draw the next one</td>
</tr>
<tr>
<td class="address-1"><span id="34544"></span>34544</td>
<td class="instruction">LD IX,33839</td>
<td class="comment-1" rowspan="4">Print 'High Score 000000&#160;&#160;&#160;Score 000000' (see <a href="33839.html">33839</a>) at (19,0)</td>
</tr>
<tr>
<td class="address-1"><span id="34548"></span>34548</td>
<td class="instruction">LD DE,20576</td>
</tr>
<tr>
<td class="address-1"><span id="34551"></span>34551</td>
<td class="instruction">LD C,32</td>
</tr>
<tr>
<td class="address-1"><span id="34553"></span>34553</td>
<td class="instruction">CALL <a href="37562.html">37562</a></td>
</tr>
<tr>
<td class="address-1"><span id="34556"></span>34556</td>
<td class="instruction">LD A,(32883)</td>
<td class="comment-1" rowspan="1">Pick up the border colour for the current cavern from <a href="32883.html">32883</a></td>
</tr>
<tr>
<td class="address-1"><span id="34559"></span>34559</td>
<td class="instruction">LD C,254</td>
<td class="comment-1" rowspan="2">Set the border colour</td>
</tr>
<tr>
<td class="address-1"><span id="34561"></span>34561</td>
<td class="instruction">OUT (C),A</td>
</tr>
<tr>
<td class="address-1"><span id="34563"></span>34563</td>
<td class="instruction">LD A,(33882)</td>
<td class="comment-1" rowspan="1">Pick up the game mode indicator from <a href="33882.html">33882</a></td>
</tr>
<tr>
<td class="address-1"><span id="34566"></span>34566</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Are we in demo mode?</td>
</tr>
<tr>
<td class="address-1"><span id="34567"></span>34567</td>
<td class="instruction">JR Z,<a href="34574.html">34574</a></td>
<td class="comment-1" rowspan="1">If not, enter the main loop now</td>
</tr>
<tr>
<td class="address-1"><span id="34569"></span>34569</td>
<td class="instruction">LD A,64</td>
<td class="comment-1" rowspan="2">Reset the game mode indicator at <a href="33882.html">33882</a> to 64 (we're in demo mode)</td>
</tr>
<tr>
<td class="address-1"><span id="34571"></span>34571</td>
<td class="instruction">LD (33882),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<div class="comments">
<div class="paragraph">
This routine continues into the main loop at <a href="34574.html">34574</a>.
</div>
</div>
</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="34252.html">34252</a>
</td>
<td class="up">Up: <a href="../maps/all.html#34436">Map</a></td>
<td class="next">
Next: <a href="34574.html">34574</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Manic Miner RAM disassembly 20191112</div>
<div class="copyright">&#169; 1983 Bug-Byte Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/8684.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>