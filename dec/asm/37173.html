<!DOCTYPE html>
<html>
<head>
<title>Manic Miner: Routine at 37173</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Manic Miner" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37125.html">37125</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37173">Map</a></td>
<td class="next">
Next: <a href="37403.html">37403</a>
</td>
</tr>
</table>
<div class="description">37173: Move and draw the Kong Beast in the current cavern</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="34574.html">34574</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37173"></span>37173</td>
<td class="instruction">LD HL,23558</td>
<td class="comment-1" rowspan="2">Flip the left-hand switch at (0,6) if Willy is touching it</td>
</tr>
<tr>
<td class="address-1"><span id="37176"></span>37176</td>
<td class="instruction">CALL <a href="37403.html">37403</a></td>
</tr>
<tr>
<td class="address-1"><span id="37179"></span>37179</td>
<td class="instruction">LD A,(32987)</td>
<td class="comment-1" rowspan="1">Pick up the Kong Beast's status from <a href="32987.html">32987</a></td>
</tr>
<tr>
<td class="address-1"><span id="37182"></span>37182</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1">Is the Kong Beast already dead?</td>
</tr>
<tr>
<td class="address-1"><span id="37184"></span>37184</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="address-1"><span id="37185"></span>37185</td>
<td class="instruction">LD A,(29958)</td>
<td class="comment-1" rowspan="1">Pick up the sixth pixel row of the left-hand switch from the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-1"><span id="37188"></span>37188</td>
<td class="instruction">CP 16</td>
<td class="comment-1" rowspan="1">Has the switch been flipped?</td>
</tr>
<tr>
<td class="address-1"><span id="37190"></span>37190</td>
<td class="instruction">JP Z,<a href="37173.html#37369">37369</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37193"></span>
<div class="comments">
<div class="paragraph">
The left-hand switch has been flipped. Deal with opening up the wall if that is still in progress.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="37193"></span>37193</td>
<td class="instruction">LD A,(24433)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte of the tile at (11,17) in the buffer at <a href="24064.html">24064</a></td>
</tr>
<tr>
<td class="address-1"><span id="37196"></span>37196</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Has the wall there been removed yet?</td>
</tr>
<tr>
<td class="address-1"><span id="37197"></span>37197</td>
<td class="instruction">JR Z,<a href="37173.html#37238">37238</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="37199"></span>37199</td>
<td class="instruction">LD HL,32625</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the bottom row of pixels of the wall tile at (11,17) in the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-2"><span id="37202"></span>37202</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up a pixel row</td>
</tr>
<tr>
<td class="address-1"><span id="37203"></span>37203</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Is it blank yet?</td>
</tr>
<tr>
<td class="address-1"><span id="37204"></span>37204</td>
<td class="instruction">JR NZ,<a href="37173.html#37228">37228</a></td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="37206"></span>37206</td>
<td class="instruction">DEC H</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next pixel row up</td>
</tr>
<tr>
<td class="address-1"><span id="37207"></span>37207</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2">Have we checked all 8 pixel rows yet?</td>
</tr>
<tr>
<td class="address-1"><span id="37208"></span>37208</td>
<td class="instruction">CP 119</td>
</tr>
<tr>
<td class="address-1"><span id="37210"></span>37210</td>
<td class="instruction">JR NZ,<a href="37173.html#37202">37202</a></td>
<td class="comment-1" rowspan="1">If not, jump back to check the next one</td>
</tr>
<tr>
<td class="address-1"><span id="37212"></span>37212</td>
<td class="instruction">LD A,(32800)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte of the background tile for the current cavern from <a href="32800.html">32800</a></td>
</tr>
<tr>
<td class="address-1"><span id="37215"></span>37215</td>
<td class="instruction">LD (24433),A</td>
<td class="comment-1" rowspan="2">Change the attributes at (11,17) and (12,17) in the buffer at <a href="24064.html">24064</a> to match the background tile (the wall there is now gone)</td>
</tr>
<tr>
<td class="address-1"><span id="37218"></span>37218</td>
<td class="instruction">LD (24465),A</td>
</tr>
<tr>
<td class="address-1"><span id="37221"></span>37221</td>
<td class="instruction">LD A,114</td>
<td class="comment-1" rowspan="2">Update the seventh byte of the guardian definition at <a href="32958.html#32965">32965</a> so that the guardian moves through the opening in the wall</td>
</tr>
<tr>
<td class="address-1"><span id="37223"></span>37223</td>
<td class="instruction">LD (32971),A</td>
</tr>
<tr>
<td class="address-1"><span id="37226"></span>37226</td>
<td class="instruction">JR <a href="37173.html#37238">37238</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="37228"></span>37228</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Clear a pixel row of the wall tile at (11,17) in the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-1"><span id="37230"></span>37230</td>
<td class="instruction">LD L,145</td>
<td class="comment-1" rowspan="4">Point <span class="register">HL</span> at the opposite pixel row of the wall tile one cell down at (12,17)</td>
</tr>
<tr>
<td class="address-1"><span id="37232"></span>37232</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="37233"></span>37233</td>
<td class="instruction">XOR 7</td>
</tr>
<tr>
<td class="address-1"><span id="37235"></span>37235</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="37236"></span>37236</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Clear that pixel row as well</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37238"></span>
<div class="comments">
<div class="paragraph">
Now check the right-hand switch.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37238"></span>37238</td>
<td class="instruction">LD HL,23570</td>
<td class="comment-1" rowspan="2">Flip the right-hand switch at (0,18) if Willy is touching it (and it hasn't already been flipped)</td>
</tr>
<tr>
<td class="address-1"><span id="37241"></span>37241</td>
<td class="instruction">CALL <a href="37403.html">37403</a></td>
</tr>
<tr>
<td class="address-1"><span id="37244"></span>37244</td>
<td class="instruction">JR NZ,<a href="37173.html#37277">37277</a></td>
<td class="comment-1" rowspan="1">Jump if the switch was not flipped</td>
</tr>
<tr>
<td class="address-1"><span id="37246"></span>37246</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Initialise the Kong Beast's pixel y-coordinate at <a href="32988.html">32988</a> to 0</td>
</tr>
<tr>
<td class="address-1"><span id="37247"></span>37247</td>
<td class="instruction">LD (32988),A</td>
</tr>
<tr>
<td class="address-1"><span id="37250"></span>37250</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2">Update the Kong Beast's status at <a href="32987.html">32987</a> to 1: he is falling</td>
</tr>
<tr>
<td class="address-1"><span id="37251"></span>37251</td>
<td class="instruction">LD (32987),A</td>
</tr>
<tr>
<td class="address-1"><span id="37254"></span>37254</td>
<td class="instruction">LD A,(32800)</td>
<td class="comment-1" rowspan="1">Pick up the attribute byte of the background tile for the current cavern from <a href="32800.html">32800</a></td>
</tr>
<tr>
<td class="address-1"><span id="37257"></span>37257</td>
<td class="instruction">LD (24143),A</td>
<td class="comment-1" rowspan="2">Change the attributes of the floor beneath the Kong Beast in the buffer at <a href="24064.html">24064</a> to match that of the background tile</td>
</tr>
<tr>
<td class="address-1"><span id="37260"></span>37260</td>
<td class="instruction">LD (24144),A</td>
</tr>
<tr>
<td class="address-1"><span id="37263"></span>37263</td>
<td class="instruction">LD HL,28751</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at (2,15) in the screen buffer at <a href="28672.html">28672</a></td>
</tr>
<tr>
<td class="address-1"><span id="37266"></span>37266</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="7">Clear the cells at (2,15) and (2,16), removing the floor beneath the Kong Beast</td>
</tr>
<tr>
<td class="address-2"><span id="37268"></span>37268</td>
<td class="instruction">LD (HL),0</td>
</tr>
<tr>
<td class="address-1"><span id="37270"></span>37270</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="37271"></span>37271</td>
<td class="instruction">LD (HL),0</td>
</tr>
<tr>
<td class="address-1"><span id="37273"></span>37273</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="37274"></span>37274</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="37275"></span>37275</td>
<td class="instruction">DJNZ <a href="37173.html#37268">37268</a></td>
</tr>
<tr>
<td class="address-2"><span id="37277"></span>37277</td>
<td class="instruction">LD A,(32987)</td>
<td class="comment-1" rowspan="1">Pick up the Kong Beast's status from <a href="32987.html">32987</a></td>
</tr>
<tr>
<td class="address-1"><span id="37280"></span>37280</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Is the Kong Beast still on the ledge?</td>
</tr>
<tr>
<td class="address-1"><span id="37281"></span>37281</td>
<td class="instruction">JR Z,<a href="37173.html#37369">37369</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37283"></span>
<div class="comments">
<div class="paragraph">
The Kong Beast is falling.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="37283"></span>37283</td>
<td class="instruction">LD A,(32988)</td>
<td class="comment-1" rowspan="1">Pick up the Kong Beast's pixel y-coordinate from <a href="32988.html">32988</a></td>
</tr>
<tr>
<td class="address-1"><span id="37286"></span>37286</td>
<td class="instruction">CP 100</td>
<td class="comment-1" rowspan="1">Has he fallen into the portal yet?</td>
</tr>
<tr>
<td class="address-1"><span id="37288"></span>37288</td>
<td class="instruction">JR Z,<a href="37173.html#37363">37363</a></td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="37290"></span>37290</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="2">Add 4 to the Kong Beast's pixel y-coordinate at <a href="32988.html">32988</a> (moving him downwards)</td>
</tr>
<tr>
<td class="address-1"><span id="37292"></span>37292</td>
<td class="instruction">LD (32988),A</td>
</tr>
<tr>
<td class="address-1"><span id="37295"></span>37295</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy the pixel y-coordinate to <span class="register">C</span>; this value determines the pitch of the sound effect</td>
</tr>
<tr>
<td class="address-1"><span id="37296"></span>37296</td>
<td class="instruction">LD D,16</td>
<td class="comment-1" rowspan="1">This value determines the duration of the sound effect</td>
</tr>
<tr>
<td class="address-1"><span id="37298"></span>37298</td>
<td class="instruction">LD A,(32883)</td>
<td class="comment-1" rowspan="1">Pick up the border colour for the current cavern from <a href="32883.html">32883</a></td>
</tr>
<tr>
<td class="address-2"><span id="37301"></span>37301</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-1" rowspan="6">Make a falling sound effect</td>
</tr>
<tr>
<td class="address-1"><span id="37303"></span>37303</td>
<td class="instruction">XOR 24</td>
</tr>
<tr>
<td class="address-1"><span id="37305"></span>37305</td>
<td class="instruction">LD B,C</td>
</tr>
<tr>
<td class="address-2"><span id="37306"></span>37306</td>
<td class="instruction">DJNZ <a href="37173.html#37306">37306</a></td>
</tr>
<tr>
<td class="address-1"><span id="37308"></span>37308</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="37309"></span>37309</td>
<td class="instruction">JR NZ,<a href="37173.html#37301">37301</a></td>
</tr>
<tr>
<td class="address-1"><span id="37311"></span>37311</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Copy the Kong Beast's pixel y-coordinate back into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="37312"></span>37312</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at the entry in the screen buffer address lookup table at <a href="33536.html">33536</a> that corresponds to the Kong Beast's pixel y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="37313"></span>37313</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="37314"></span>37314</td>
<td class="instruction">LD D,131</td>
</tr>
<tr>
<td class="address-1"><span id="37316"></span>37316</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="6">Point <span class="register">HL</span> at the address of the Kong Beast's location in the screen buffer at <a href="24576.html">24576</a></td>
</tr>
<tr>
<td class="address-1"><span id="37317"></span>37317</td>
<td class="instruction">OR 15</td>
</tr>
<tr>
<td class="address-1"><span id="37319"></span>37319</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="37320"></span>37320</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="address-1"><span id="37321"></span>37321</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="37322"></span>37322</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="37323"></span>37323</td>
<td class="instruction">LD D,129</td>
<td class="comment-1" rowspan="5">Use bit 5 of the value of the game clock at <a href="32957.html">32957</a> (which is toggled once every eight passes through the main loop) to point <span class="register">DE</span> at the graphic data for the appropriate Kong Beast sprite</td>
</tr>
<tr>
<td class="address-1"><span id="37325"></span>37325</td>
<td class="instruction">LD A,(32957)</td>
</tr>
<tr>
<td class="address-1"><span id="37328"></span>37328</td>
<td class="instruction">AND 32</td>
</tr>
<tr>
<td class="address-1"><span id="37330"></span>37330</td>
<td class="instruction">OR 64</td>
</tr>
<tr>
<td class="address-1"><span id="37332"></span>37332</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="37333"></span>37333</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="2">Draw the Kong Beast to the screen buffer at <a href="24576.html">24576</a></td>
</tr>
<tr>
<td class="address-1"><span id="37335"></span>37335</td>
<td class="instruction">CALL <a href="36852.html">36852</a></td>
</tr>
<tr>
<td class="address-1"><span id="37338"></span>37338</td>
<td class="instruction">LD HL,33836</td>
<td class="comment-1" rowspan="2">Add 100 to the score</td>
</tr>
<tr>
<td class="address-1"><span id="37341"></span>37341</td>
<td class="instruction">CALL <a href="37098.html#37118">37118</a></td>
</tr>
<tr>
<td class="address-1"><span id="37344"></span>37344</td>
<td class="instruction">LD A,(32988)</td>
<td class="comment-1" rowspan="1">Pick up the Kong Beast's pixel y-coordinate from <a href="32988.html">32988</a></td>
</tr>
<tr>
<td class="address-1"><span id="37347"></span>37347</td>
<td class="instruction">AND 120</td>
<td class="comment-1" rowspan="8">Point <span class="register">HL</span> at the address of the Kong Beast's location in the attribute buffer at <a href="23552.html">23552</a></td>
</tr>
<tr>
<td class="address-1"><span id="37349"></span>37349</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="37350"></span>37350</td>
<td class="instruction">LD H,23</td>
</tr>
<tr>
<td class="address-1"><span id="37352"></span>37352</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="37353"></span>37353</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="37354"></span>37354</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="37355"></span>37355</td>
<td class="instruction">OR 15</td>
</tr>
<tr>
<td class="address-1"><span id="37357"></span>37357</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="37358"></span>37358</td>
<td class="instruction">LD A,6</td>
<td class="comment-1" rowspan="1">The Kong Beast is drawn with yellow INK</td>
</tr>
<tr>
<td class="address-1"><span id="37360"></span>37360</td>
<td class="instruction">JP <a href="36344.html#36447">36447</a></td>
<td class="comment-1" rowspan="1">Set the attribute bytes for the Kong Beast</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37363"></span>
<div class="comments">
<div class="paragraph">
The Kong Beast has fallen into the portal.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37363"></span>37363</td>
<td class="instruction">LD A,2</td>
<td class="comment-1" rowspan="2">Set the Kong Beast's status at <a href="32987.html">32987</a> to 2: he is dead</td>
</tr>
<tr>
<td class="address-1"><span id="37365"></span>37365</td>
<td class="instruction">LD (32987),A</td>
</tr>
<tr>
<td class="address-1"><span id="37368"></span>37368</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="37369"></span>
<div class="comments">
<div class="paragraph">
The Kong Beast is still on the ledge.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="37369"></span>37369</td>
<td class="instruction">LD A,(32957)</td>
<td class="comment-1" rowspan="1">Pick up the value of the game clock at <a href="32957.html">32957</a></td>
</tr>
<tr>
<td class="address-1"><span id="37372"></span>37372</td>
<td class="instruction">AND 32</td>
<td class="comment-1" rowspan="3">Use bit 5 of this value (which is toggled once every eight passes through the main loop) to point <span class="register">DE</span> at the graphic data for the appropriate Kong Beast sprite</td>
</tr>
<tr>
<td class="address-1"><span id="37374"></span>37374</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="37375"></span>37375</td>
<td class="instruction">LD D,129</td>
</tr>
<tr>
<td class="address-1"><span id="37377"></span>37377</td>
<td class="instruction">LD HL,24591</td>
<td class="comment-1" rowspan="3">Draw the Kong Beast at (0,15) in the screen buffer at <a href="24576.html">24576</a></td>
</tr>
<tr>
<td class="address-1"><span id="37380"></span>37380</td>
<td class="instruction">LD C,1</td>
</tr>
<tr>
<td class="address-1"><span id="37382"></span>37382</td>
<td class="instruction">CALL <a href="36852.html">36852</a></td>
</tr>
<tr>
<td class="address-1"><span id="37385"></span>37385</td>
<td class="instruction">JP NZ,<a href="36101.html#36102">36102</a></td>
<td class="comment-1" rowspan="1">Kill Willy if he collided with the Kong Beast</td>
</tr>
<tr>
<td class="address-1"><span id="37388"></span>37388</td>
<td class="instruction">LD A,68</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=68 (INK 4: PAPER 0: BRIGHT 1)</td>
</tr>
<tr>
<td class="address-1"><span id="37390"></span>37390</td>
<td class="instruction">LD (23599),A</td>
<td class="comment-1" rowspan="4">Set the attribute bytes for the Kong Beast in the buffer at <a href="23552.html">23552</a></td>
</tr>
<tr>
<td class="address-1"><span id="37393"></span>37393</td>
<td class="instruction">LD (23600),A</td>
</tr>
<tr>
<td class="address-1"><span id="37396"></span>37396</td>
<td class="instruction">LD (23567),A</td>
</tr>
<tr>
<td class="address-1"><span id="37399"></span>37399</td>
<td class="instruction">LD (23568),A</td>
</tr>
<tr>
<td class="address-1"><span id="37402"></span>37402</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37125.html">37125</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37173">Map</a></td>
<td class="next">
Next: <a href="37403.html">37403</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Manic Miner RAM disassembly 20221122</div>
<div class="copyright">&#169; 1983 Bug-Byte Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/9135.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>