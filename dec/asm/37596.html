<!DOCTYPE html>
<html>
<head>
<title>Manic Miner: Routine at 37596</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Manic Miner" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37579.html">37579</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37596">Map</a></td>
<td class="next">
Next: <a href="37675.html">37675</a>
</td>
</tr>
</table>
<div class="description">37596: Play the theme tune (The Blue Danube)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="34252.html">34252</a>. Returns with the zero flag reset if ENTER or the fire button is pressed while the tune is being played.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc"><a href="33902.html">33902</a> (tune data)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="37596"></span>37596</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-1" rowspan="1">Pick up the next byte of tune data from the table at <a href="33902.html">33902</a></td>
</tr>
<tr>
<td class="address-1"><span id="37599"></span>37599</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">Has the tune finished?</td>
</tr>
<tr>
<td class="address-1"><span id="37601"></span>37601</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Return (with the zero flag set) if so</td>
</tr>
<tr>
<td class="address-1"><span id="37602"></span>37602</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy the first byte of data for this note (which determines the duration) to <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="37603"></span>37603</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Initialise <span class="register">B</span>, which will be used as a delay counter in the note-producing loop</td>
</tr>
<tr>
<td class="address-1"><span id="37605"></span>37605</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span>=0 (for no apparent reasaon)</td>
</tr>
<tr>
<td class="address-1"><span id="37606"></span>37606</td>
<td class="instruction">LD D,(IY+1)</td>
<td class="comment-1" rowspan="1">Pick up the second byte of data for this note</td>
</tr>
<tr>
<td class="address-1"><span id="37609"></span>37609</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1">Copy it to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="37610"></span>37610</td>
<td class="instruction">CALL <a href="37675.html">37675</a></td>
<td class="comment-1" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="address-1"><span id="37613"></span>37613</td>
<td class="instruction">LD (HL),80</td>
<td class="comment-1" rowspan="1">Set the attribute byte for the piano key to 80 (INK 0: PAPER 2: BRIGHT 1)</td>
</tr>
<tr>
<td class="address-1"><span id="37615"></span>37615</td>
<td class="instruction">LD E,(IY+2)</td>
<td class="comment-1" rowspan="1">Pick up the third byte of data for this note</td>
</tr>
<tr>
<td class="address-1"><span id="37618"></span>37618</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1">Copy it to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="37619"></span>37619</td>
<td class="instruction">CALL <a href="37675.html">37675</a></td>
<td class="comment-1" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="address-1"><span id="37622"></span>37622</td>
<td class="instruction">LD (HL),40</td>
<td class="comment-1" rowspan="1">Set the attribute byte for the piano key to 40 (INK 0: PAPER 5: BRIGHT 0)</td>
</tr>
<tr>
<td class="address-2"><span id="37624"></span>37624</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-1" rowspan="12">Produce a sound based on the frequency parameters in the second and third bytes of data for this note (copied into <span class="register">D</span> and <span class="register">E</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="37626"></span>37626</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="37627"></span>37627</td>
<td class="instruction">JR NZ,<a href="37596.html#37634">37634</a></td>
</tr>
<tr>
<td class="address-1"><span id="37629"></span>37629</td>
<td class="instruction">LD D,(IY+1)</td>
</tr>
<tr>
<td class="address-1"><span id="37632"></span>37632</td>
<td class="instruction">XOR 24</td>
</tr>
<tr>
<td class="address-2"><span id="37634"></span>37634</td>
<td class="instruction">DEC E</td>
</tr>
<tr>
<td class="address-1"><span id="37635"></span>37635</td>
<td class="instruction">JR NZ,<a href="37596.html#37642">37642</a></td>
</tr>
<tr>
<td class="address-1"><span id="37637"></span>37637</td>
<td class="instruction">LD E,(IY+2)</td>
</tr>
<tr>
<td class="address-1"><span id="37640"></span>37640</td>
<td class="instruction">XOR 24</td>
</tr>
<tr>
<td class="address-2"><span id="37642"></span>37642</td>
<td class="instruction">DJNZ <a href="37596.html#37624">37624</a></td>
</tr>
<tr>
<td class="address-1"><span id="37644"></span>37644</td>
<td class="instruction">DEC C</td>
</tr>
<tr>
<td class="address-1"><span id="37645"></span>37645</td>
<td class="instruction">JR NZ,<a href="37596.html#37624">37624</a></td>
</tr>
<tr>
<td class="address-1"><span id="37647"></span>37647</td>
<td class="instruction">CALL <a href="37687.html">37687</a></td>
<td class="comment-1" rowspan="1">Check whether ENTER or the fire button is being pressed</td>
</tr>
<tr>
<td class="address-1"><span id="37650"></span>37650</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return (with the zero flag reset) if it is</td>
</tr>
<tr>
<td class="address-1"><span id="37651"></span>37651</td>
<td class="instruction">LD A,(IY+1)</td>
<td class="comment-1" rowspan="1">Pick up the second byte of data for this note</td>
</tr>
<tr>
<td class="address-1"><span id="37654"></span>37654</td>
<td class="instruction">CALL <a href="37675.html">37675</a></td>
<td class="comment-1" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="address-1"><span id="37657"></span>37657</td>
<td class="instruction">LD (HL),56</td>
<td class="comment-1" rowspan="1">Set the attribute byte for the piano key back to 56 (INK 0: PAPER 7: BRIGHT 0)</td>
</tr>
<tr>
<td class="address-1"><span id="37659"></span>37659</td>
<td class="instruction">LD A,(IY+2)</td>
<td class="comment-1" rowspan="1">Pick up the third byte of data for this note</td>
</tr>
<tr>
<td class="address-1"><span id="37662"></span>37662</td>
<td class="instruction">CALL <a href="37675.html">37675</a></td>
<td class="comment-1" rowspan="1">Calculate the attribute file address for the corresponding piano key</td>
</tr>
<tr>
<td class="address-1"><span id="37665"></span>37665</td>
<td class="instruction">LD (HL),56</td>
<td class="comment-1" rowspan="1">Set the attribute byte for the piano key back to 56 (INK 0: PAPER 7: BRIGHT 0)</td>
</tr>
<tr>
<td class="address-1"><span id="37667"></span>37667</td>
<td class="instruction">INC IY</td>
<td class="comment-1" rowspan="3">Move <span class="register">IY</span> along to the data for the next note in the tune</td>
</tr>
<tr>
<td class="address-1"><span id="37669"></span>37669</td>
<td class="instruction">INC IY</td>
</tr>
<tr>
<td class="address-1"><span id="37671"></span>37671</td>
<td class="instruction">INC IY</td>
</tr>
<tr>
<td class="address-1"><span id="37673"></span>37673</td>
<td class="instruction">JR <a href="37596.html#37596">37596</a></td>
<td class="comment-1" rowspan="1">Jump back to play the next note</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="37579.html">37579</a>
</td>
<td class="up">Up: <a href="../maps/all.html#37596">Map</a></td>
<td class="next">
Next: <a href="37675.html">37675</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Manic Miner RAM disassembly 20221122</div>
<div class="copyright">&#169; 1983 Bug-Byte Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/92DC.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>